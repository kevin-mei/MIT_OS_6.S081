贝尔实验室和CSP线程
拉斯·考克斯
rsc@swtch.com

同时有塞尔维亚-克罗地亚， 瑞典

介绍

该页面是并发编程历史的一部分，重点介绍了Hoare的顺序顺序通信（CSP​​）语言[1] [1a]的特定血统 。这种风格的并发编程很有趣，原因不是效率而是清晰。即，仅将并发编程视为提高性能的一种手段是一个普遍的错误， 例如，以重叠磁盘I / O请求，通过将结果预取到预期的查询来减少延迟，或利用多个处理器。这些优势很重要，但与本讨论无关。毕竟，它们可以用其他样式来实现，例如异步事件驱动的编程。相反，我们对并发编程很感兴趣，因为它提供了自然的抽象，可以使某些程序更简单。

这不是什么

大多数计算机科学专业的本科生都被迫阅读安德鲁·比雷尔（Andrew Birrell）的 “线程编程简介”。 SRC线程模型是当前可用的大多数线程包使用的模型。所有这些的问题在于它们太低级了。与Hoare提供的通信原语不同，SRC样式线程模块中的原语必须与其他技术（通常是共享内存）组合才能有效使用。通常，程序员倾向于不构建自己的高级结构，而由于需要注意这些低级细节而感到沮丧。

目前，将Birrell的教程排除在外。这是一个不同的线程模型。如果您将其作为其他线程模型来处理，则可能会更容易理解。

顺序流程沟通

到1978年，在对多处理器进行编程的情况下，有许多提议的方法用于通信和同步。共享内存是最常见的通信机制，而信号量，关键区域和监视器则属于同步机制。CAR Hoare使用一种语言原语解决了这两个问题：同步通信。在Hoare的CSP语言中，进程通过从命名的未缓冲通道发送或接收值进行通信。由于通道是无缓冲的，因此发送操作将阻塞，直到将值传输到接收器为止，从而提供了一种同步机制。

Hoare的示例之一是重新格式化80列卡片以在125列打印机上进行打印的格式。在他的解决方案中，一个进程一次读取一张卡，将分解后的内容逐个字符发送到第二个进程。第二个过程将组合125个字符的组，然后将这些组发送到行式打印机。这听起来很琐碎，但是在没有缓冲的I / O库的情况下，单进程解决方案中涉及的必要簿记工作繁重。实际上，缓冲的I / O库实际上只是导出单字符通信接口的这两种过程的封装。

举另一个例子，霍亚尔（Hoare）归功于道格·麦克罗伊（Doug McIlroy），考虑所有质数的生成少于一千。可以通过执行以下伪代码的一系列流程来模拟Eratosthenes的筛网：

p =从左邻居得到一个数字
打印p
环形：
    n =从左邻居得到一个数字
    如果（p不除n）
        发送n到正确的邻居
生成过程可以将数字2、3、4，...，1000馈入管道的左端：该行中的第一个过程消除了2的倍数，第二个过程消除了3的倍数，第三个过程消除了5的倍数，依此类推：



到目前为止，示例的线性管线性质不能正确代表CSP的一般性质，但即使限于线性管线，该模型也非常强大。Unix操作系统众所周知的过滤器和管道方法的成功已经有力地证明了这种能力。 [2] 实际上，管道早于Hoare的论文。在1964年10月11日的贝尔实验室内部备忘录中，道格·麦克罗伊（Doug McIlroy）玩弄了将成为Unix管道的想法：“我们应该有一些耦合程序的方法，例如花园软管，当有必要对数据进行按摩时，将其拧入另一个部分。其他方式。这也是IO的方式。” [3]

Hoare的通信过程比典型的Unix Shell管道更通用，因为它们可以以任意模式连接。实际上，Hoare给出了一个3x3的处理矩阵示例，该矩阵有点像素筛，可用于将矢量乘以3x3的正方形矩阵。

当然，Unix管道机制不需要线性布局。只有shell语法可以。McIlroy报告说，早期使用通用语法对外壳的语法进行了玩弄，但对语法的接受程度不足以实现它（个人交流，2011年）。后来的外壳确实支持非线性管道的某些受限形式。Rochkind的2dsh支持dags；汤姆·达夫（Tom Duff）的rc支持树木。

Hoare的语言新颖新颖，很有影响力，但缺乏一些关键方面。主要缺陷是用于通信的未缓冲通道不是一流的对象：它们不能存储在变量中，不能作为参数传递给函数或跨通道发送。结果，在编写程序时必须固定通信结构。因此，我们必须编写一个程序来打印前1000个素数，而不是前n个素数，并将向量乘以3x3矩阵而不是n x n矩阵。

潘与普罗梅拉

1980年，距Hoare的论文发表仅短短两年时间，Gerard Holzmann和Rob Pike创建了一个协议分析器，称为pan，它将CSP方言作为输入。Pan的CSP方言具有串联，选择和循环的功能，但是没有变量。即便如此，霍尔兹曼报告说：“潘在1980年11月21日的Bell Labs数据交换控制协议中发现了它的第一个错误。” [14]。该方言很可能是Bell Labs的第一种CSP语言，它无疑为Pike提供了使用和实现类似CSP的语言的经验，这是他的第一种语言。

Holzmann的协议分析仪已发展为Spin模型检查器及其Promela语言，它具有与Newsqueak（qv）相同的一流频道。

新闻快讯

朝着不同的方向发展，Luca Cardelli和Rob Pike将CSP中的思想发展成Squeak微型语言 [4]， 用于生成用户界面代码。（此Squeak与Squeak Smalltalk实现不同。）Pike随后将Squeak扩展为成熟的编程语言Newsqueak [5] [6] ，该语言源自 Plan 9的Alef [7] [8]，Inferno的Limbo [9]和Google的去 [13]。相较于Squeak，Newsqueak的主要语义优势在于Newsqueak将通信渠道视为一流的对象：与CSP和Squeak不同，渠道 可以 被存储在变量中，作为参数传递给函数，并通过通道发送。这继而实现了通信结构的程序化构造，从而允许创建比手工设计合理的结构更复杂的结构。尤其是，道格·麦克罗伊（Doug McIlroy）演示了如何利用Newsqueak的通讯工具编写精美的程序来处理符号幂级数 [10]。传统语言中的类似尝试往往会使簿记工作陷入困境。同样，罗伯·派克（Rob Pike）演示了如何利用通信工具来突破常见的基于事件的编程模型，并编写了并发窗口系统 [11]。

阿列夫

Alef [7] [8] 是由Phil Winterbottom设计的一种语言，用于将Newsqueak的思想应用于成熟的系统编程语言。Alef有两种我们称为进程的类型：proc和线程。该程序被组织为一个或多个proc，它们是可以抢先调度的共享内存操作系统进程。每个proc包含一个或多个任务，这些任务是协同调度的协程。请注意，每个任务都分配给一个特定的proc：它们不会在proc之间迁移。

proc的主要用途是提供可以独立于主要任务而阻止I / O的上下文。（Plan 9有没有选择调用，甚至在Unix上，如果你想与非网络I / O重叠计算你需要多个特效。）Acme的论文 [12] 有特效和线程的一个很好的简短的讨论，因为这样做 的关于Plan 9窗口系统的讲义，也将在下面提及。

凌波

Inferno操作系统是计划9衍生产品，用于机顶盒。它的编程语言Limbo [9]受Alef的影响很大。它消除了proc和任务之间的区别，实际上仅包含proc，尽管它们的权重比大多数人认为的流程轻。所有并行性都是抢先的。有趣的是，尽管如此，该语言仍未提供对锁定的真正支持。取而代之的是，通道通信通常提供足够的同步，并鼓励程序员安排任何数据始终拥有明确的所有者。不需要明确的锁定。

线程线程

回到计划9的世界，随着计划9移植到越来越多的体系结构上，Alef编译器变得难以维护。最初创建Libthread是为了将Alef程序移植到C，以便可以淘汰Alef编译器。Alef的proc和任务在libthread中称为proc和线程。该手册 是最权威的参考。

去

Rob Pike和Ken Thompson转到了Google，并将CSP置于Go语言并发支持的中心。

入门

为了对模型有所了解，特别是进程和线程如何交互，值得阅读《 Alef用户指南》 [8]。此演示文稿的前三十张幻灯片 很好地介绍了如何在C中表示Alef构造。

CSP模型功能的最好例子是上文提到的McIlroy和Pike的论文 [10] [11]。

Rob Pike的主页包含有关并发编程的课程的讲义： 简介，并介绍了上述两篇论文的幻灯片： 斜视 和 窗口系统。这三个中的最后一个提供了一个很好的示例，说明了Plan 9程序通常如何使用proc和任务。

罗伯·派克（Rob Pike）在Google 上进行了一次 技术演讲，提供了很好的介绍（57分钟的视频）。

Rob Pike在2010年与Ru​​ss Cox进行的Google I / O演讲中的一半 展示了如何使用通道和Go的并发性来实现负载平衡工作管理系统。

相关资源

John Reppy将相同的思想应用于ML，从而产生了Concurrent ML。他使用CML来构建eXene多线程（非事件驱动）X Window System工具箱。

参考

[1] CAR Hoare，《通信顺序过程》 ，ACM通讯 21（8）（1978年8月），第666-677页。

[1a] CAR Hoare， 沟通顺序过程。普伦蒂斯·霍尔（Prentice Hall），新泽西州恩格尔伍德悬崖（Englewood Cliffs），1985年。

[2] Michael S. Mahoney编辑， 《 Unix口述历史项目，第0版：开始》

[3] 道格拉斯·麦克罗伊（M. Douglas McIlroy）， 贝尔实验室内部备忘录，1964年10月。

[4] 卢卡·卡德利（Luca Cardelli）和罗伯·派克（Rob Pike）， “吱吱声：一种与小鼠交流的语言”，《 计算机图形学》，19（3）（1985年7月：SIGGRAPH '85会议论文集），第199-204页。

[5] Rob Pike， “ Newsqueak的实现”， 软件-实践与经验，20（7）（1990年7月），649-659。

[6] Rob Pike， “ Newsqueak：一种与小鼠交流的语言”， 计算机科学技术报告143，AT＆T贝尔实验室，默里·希尔，1989年。

[7] Phil Winterbottom， “ Alef语言参考手册” ， Plan 9程序员手册：第二卷，AT＆T，Murray Hill，1995年。

[8] 鲍勃Flandrena， “Alef的用户指南，” 在 计划9程序员手册：第二卷，AT＆T，美利山，1995年。

[9] Dennis M. Ritchie， “ The Limbo编程语言”， 在 Inferno程序员手册，第2卷，Vita Nuova Holdings Ltd.，约克，2000年。

[10] M. Douglas McIlroy， “在电源系列上斜眼看”， 软件－实践和经验，20（7）（1990年7月），661-683。

[11] Rob Pike， “并发窗口系统”， 计算系统，2（2）133-153。

[12] Rob Pike， “ Acme：程序员的用户界面” ，1994年冬季USENIX会议论文集，223-234。

[13] golang.org， “ Go编程语言”。

[14] Gerard Holzmann，“自旋的根源”。

[15] Gerard Holzmann，“ Promela语言参考”。